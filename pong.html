<!DOCTYPE html>
<head>
    <title>Pong</title>
    <script src="../pixi.js"></script>
    <!--<script src="js/index.js"></script>-->
</head>
<body style="margin: 0;">
    <script type="module">
        const width = window.innerWidth, height = window.innerHeight - 5;
        let speed = 10.0;
        let keyMap = {};

        const app = new PIXI.Application();
        await app.init({ width: width, height: height });
        document.body.appendChild(app.canvas);

        await PIXI.Assets.load('Assets/Pong/Computer.png');
        let p1 = PIXI.Sprite.from('Assets/Pong/Computer.png');
        app.stage.addChild(p1);

        await PIXI.Assets.load('Assets/Pong/Player.png');
        let p2 = PIXI.Sprite.from('Assets/Pong/Player.png');
        app.stage.addChild(p2);
        p2.x = width - p2.width;

        await PIXI.Assets.load('Assets/Pong/Ball.png');
        let ball = PIXI.Sprite.from('Assets/Pong/Ball.png');
        app.stage.addChild(ball);
        ball.anchor.set(0.5);
        ball.x = width / 2;
        ball.y = height / 2;

        let score1 = new PIXI.Text("0", { fontFamily : "Arial", fontSize: 24, fill : 0xFFFFFF });
        app.stage.addChild(score1);
        score1.x = width / 2 - score1.width;
        let score2 = new PIXI.Text("0", { fontFamily : "Arial", fontSize: 24, fill : 0xFFFFFF });
        app.stage.addChild(score2);
        score2.x = width / 2 + score2.width;

        let direction = Math.random() * 1000 % 360;
        console.log(direction);

        let elapsed = 0.0;
        
        window.onkeyup = function(e) { keyMap[e.keyCode] = false; console.log("keyup " + e.keyCode);}
        window.onkeydown = function(e) { keyMap[e.keyCode] = true; console.log("keydown " + e.keyCode);}

        app.ticker.add((ticker) => {
            elapsed += ticker.deltaTime;
            if(keyMap["87"]) { //W
                p1.y -= speed;
                if(p1.y < 0) {
                    p1.y = 0;
                }
            }
            if(keyMap["83"]) { //S
                p1.y += speed;
                if(p1.y > height - p1.height) {
                    p1.y = height - p1.height;
                }
            }
            if(keyMap["38"]) { //arrowUp
                p2.y -= speed;
                if(p2.y < 0) {
                    p2.y = 0;
                }
            }
            if(keyMap["40"]) { //arrowDown
                p2.y += speed;
                if(p2.y > height - p2.height) {
                    p2.y = height - p2.height;
                }
            }
            if(ball.x < p1.width) {
                if(ball.y > p1.y && ball.y < p1.y + p1.height && ball.x > 0) {
                    direction = map(ball.y - p1.y, 0, p1.height, -45, 45);
                }
                else if(ball.x < -ball.width){
                    score2.text = parseInt(score2.text) + 1;
                    direction = Math.random() * 1000 % 360;
                    console.log(direction);
                    ball.x = width / 2;
                    ball.y = height / 2;
                }
            }
            if(ball.x > width - p2.width){
                if(ball.y > p2.y && ball.y < p2.y + p2.height && ball.x < width) {
                    direction = 180 - map(ball.y - p2.y, 0, p2.height, -45, 45);;
                } else if(ball.x > width + ball.width) {
                    score1.text = parseInt(score1.text) + 1;
                    direction = Math.random() * 1000 % 360;
                    console.log(direction);
                    ball.x = width / 2;
                    ball.y = height / 2;
                }
            }
            if(ball.y < ball.width / 2) {
                direction = 360 - direction;
            }
            if(ball.y > height - ball.height / 2) {
                direction = 360 - direction;
            }
            ball.x = ball.x + Math.cos(direction * Math.PI / 180) * speed;
            ball.y = ball.y + Math.sin(direction * Math.PI / 180) * speed;
            //p1.y = 100.0 + Math.cos(elapsed/50.0) * 100.0;
            //p2.y = 100.0 + Math.cos(elapsed/50.0) * 100.0;
        })
        function map(value, inMin, inMax, outMin, outMax) {
            return outMin + (outMax - outMin) * (value - inMin) / (inMax - inMin);
        }
    </script>
</body>
</html>