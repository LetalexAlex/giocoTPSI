<!DOCTYPE html>
<head>
    <title>Flappy Bird</title>
    <script src="../pixi.js"></script>
    <!--<script src="js/index.js"></script>-->
</head>
<body style="margin: 0;">
    <script type="module">
        const width = window.innerWidth, height = window.innerHeight - 5;
        let speed = 0.0;
        let g = 0.0981 * 5
        let pipespeed = 5;
        let keyMap = {};
        let game = false

        const app = new PIXI.Application();
        await app.init({ width: width, height: height });
        document.body.appendChild(app.canvas);

        await PIXI.Assets.load('Assets/Flappy Bird/bird.png');
        let bird = PIXI.Sprite.from('Assets/Flappy Bird/bird.png');
        bird.x = width / 4 - bird.width / 2;
        bird.y = height / 2 - bird.height / 2;
        app.stage.addChild(bird);
        
        await PIXI.Assets.load('Assets/Flappy Bird/pipe-green.png');
        let pipetop = PIXI.Sprite.from('Assets/Flappy Bird/pipe-green.png');
        let pipebottom = PIXI.Sprite.from('Assets/Flappy Bird/pipe-green.png');
        app.stage.addChild(pipetop);
        app.stage.addChild(pipebottom)
        pipetop.scale.y = -1
        setPipes()

        let score = new PIXI.Text("Premi Spazio per iniziare", { fontFamily : "Arial", fontSize: 24, fill : 0xFFFFFF });
        app.stage.addChild(score);
        score.x = width / 2 - score.width / 2;

        let elapsed = 0.0;
        
        window.onkeyup = function(e) { keyMap[e.keyCode] = false; console.log("keyup " + e.keyCode);}
        window.onkeydown = function(e) { keyMap[e.keyCode] = true; console.log("keydown " + e.keyCode);}

        app.ticker.add((ticker) => {
            elapsed += ticker.deltaTime;
            if(game) {
                speed += g;
                bird.y += speed * ticker.deltaTime;
                if(keyMap["32"] && speed > 0) {
                    speed = -10;
                }
                pipetop.x -= pipespeed;
                pipebottom.x -= pipespeed;
                if(pipetop.x + pipetop.width < 0) {
                    score.text = parseInt(score.text) + 1;
                    setPipes()
                }
                if(checkCollision()) {
                    game = false;
                    score.text = "Game Over, Premi Spazio per Re-iniziare";
                }
            } else {
                if(keyMap["32"]) {
                    game = true;
                    bird.y = height / 2;
                    setPipes();
                    score.text = "0";
                }
            }
        })
        
        function setPipes() {
            let pipeY = Math.random() * 1000 % (height - height / 3) + height / 5;
            console.log(pipeY)
            pipetop.x = width;
            pipebottom.x = width;
            pipetop.y = pipeY - bird.height / 2 * 7;
            pipebottom.y = pipeY + bird.height / 2 * 7;
        }
        function checkCollision() {
            if (bird.y < 0 || bird.y > height) {
                return true;
            }
            if (bird.x + bird.width > pipetop.x && bird.x < pipetop.x + pipetop.width) {
                if (bird.y < pipetop.y || bird.y + bird.height > pipebottom.y) {
                    return true;
                }
            }
            return false;
        }

    </script>
</body>
</html>